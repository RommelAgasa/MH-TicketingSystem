@using Microsoft.AspNetCore.Identity
@inject UserManager<IdentityUser> UserManager
@* @model IEnumerable<UserTicketConversation> *@

@{
	Layout = "_HomeLayout";
	ViewData["Title"] = "Metro Health Ticketing System";
	var currentUser = await UserManager.GetUserAsync(User);
	var currentUserId = currentUser?.Id; // User's unique ID
	var currentUserName = currentUser?.UserName; // User's username
}

<style>
	/*Message UI*/
	.chat-messages {
		display: flex;
		flex-direction: column;
		max-height: 600px;
		overflow-y: scroll
	}

	.chat-message-left,
	.chat-message-right {
		display: flex;
		flex-shrink: 0
	}

	.chat-message-left {
		margin-right: auto
	}

	.chat-message-right {
		flex-direction: row-reverse;
		margin-left: auto
	}

	.py-3 {
		padding-top: 1rem !important;
		padding-bottom: 1rem !important;
	}

	.px-4 {
		padding-right: 1.5rem !important;
		padding-left: 1.5rem !important;
	}

	.flex-grow-0 {
		flex-grow: 0 !important;
	}

	.border-top {
		border-top: 1px solid #dee2e6 !important;
	}
</style>

<div class="container">
	<div class="card my-3 shadow-sm">
		<div class="card-body">
			<h4 class="card-title text-primary">@ViewBag.Ticket.Subject</h4>
			<hr />
			<p class="card-text text-muted">
				<strong>Description:</strong> @ViewBag.Ticket.Description
			</p>
			<hr />
			<div class="d-flex align-items-center">
				<p class="mb-0 me-3">
					<strong>Uploaded File:</strong> @ViewBag.Ticket.FileName
				</p>

				<a href="@Url.Action("DownloadFile", "Ticket",
					new { filePath = ViewBag.Ticket.FilePath, fileName = ViewBag.Ticket.FileName })"
				   download class="btn btn-outline-primary btn-sm">
					<i class="bi bi-download"></i> Download
				</a>
			</div>
		</div>
	</div>

	<div class="card">
		<div class="row g-0">
			<div class="col-12 ">
				<div class="py-2 px-4 border-bottom">
					<div class="d-flex align-items-center py-1">
@* 						<div class="position-relative m-3">
							<img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
						</div> *@
						<div class="flex-grow-1 pl-3">
							<strong>
								<h3>@Model[0].Department</h3>
							</strong>
						</div>
					</div>
				</div>
				<div class="position-relative">
					<div class="chat-messages p-4" id="messagesList">
						@foreach (var conversation in Model)
						{
							// Check if the message is from the current user or someone else
							var isCurrentUser = conversation.UserId == currentUserId; // Assuming you have the current user's ID
							var user = conversation.UserId == currentUserId ? "You" : conversation.Username;
							<div class="@((isCurrentUser ? "chat-message-right" : "chat-message-left") + " pb-4")">
								<div>
									<div class="text-muted small text-nowrap mt-2">
										@conversation.Timestamp.ToString("HH:mm")
									</div>
								</div>
								<div class="flex-shrink-1 bg-light rounded py-2 px-3 @(isCurrentUser ? "mr-3" : "ml-3")">
									<div class="font-weight-bold mb-1">
										@user
									</div>
									@conversation.Message
									@if (!string.IsNullOrEmpty(conversation.FileName) && !string.IsNullOrEmpty(conversation.FilePath))
									{
										<div>
											<a href="@Url.Action("DownloadFile", "Ticket",
											new { filePath = conversation.FilePath, fileName = conversation.FileName })"
											target="_blank">
												<i class="fas fa-arrow-circle-down"></i>
											@conversation.FileName</a>
										</div>
									}
								</div>
							</div>
						}
				</div>

				<div class="flex-grow-0 py-3 px-4 border-top">
					<div class="form-group py-2">
						<label for="sendPhoto">Send Photo: </label>
						<input id="file" type="file" class="form-control-file">
						<input id="ticketId" type="hidden" value="@ViewBag.Ticket.Id"/>
					</div>
					<div class="input-group">
						<input type="text" class="form-control" placeholder="Type your message" id="messageInput">
						<button id="sendButton" class="btn btn-primary">Send</button>
					</div>
				</div>

			</div>
		</div>

	</div>
</div>

<!--   Core JS Files   -->
<script src="~/js/core/jquery-3.7.1.min.js"></script>
<script src="~/js/core/popper.min.js"></script>
<script src="~/js/core/bootstrap.min.js"></script>
<script src="~/vendor/toastr/js/toastr.min.js"></script>
<!-- Kaiadmin JS -->
<script src="~/js/kaiadmin.min.js" asp-append-version="true"></script>
<script src="~/js/dist/browser/signalr.js"></script>
<script src="~/js/dist/browser/signalr.min.js"></script>
<script src="~/js/chat.js"></script>

<script>
	const currentUser = {
		id: '@currentUserId',
		name: '@currentUserName'
	};
</script>
